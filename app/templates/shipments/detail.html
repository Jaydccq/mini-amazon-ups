{% raw %}{% extends "layout.html" %}

{% block title %}Shipment Tracking | Mini-Amazon{% endblock %}

{% block extra_css %}
<style>
    .tracking-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #dee2e6; /* Default gray */
        display: inline-block;
        margin-right: 8px;
    }

    .tracking-dot.active {
        background-color: #28a745; /* Green when active */
    }

    .tracking-line {
        width: 2px;
        background-color: #dee2e6; /* Default gray */
        height: 40px; /* Adjust height between dots */
        margin-left: 9px; /* Align with the center of the dot */
        margin-bottom: -5px; /* Adjust spacing */
    }

    .tracking-line.active {
        background-color: #28a745; /* Green when active */
    }

    .map-container {
        height: 300px;
        width: 100%;
        background-color: #f8f9fa; /* Light gray background */
        position: relative;
        border: 1px solid #dee2e6; /* Light border */
        border-radius: 0.25rem;
        overflow: hidden; /* Hide parts of elements outside the container */
    }

    .map-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: 20px 20px; /* Size of grid squares */
        background-image: linear-gradient(to right, #e9ecef 1px, transparent 1px), /* Vertical lines */
                         linear-gradient(to bottom, #e9ecef 1px, transparent 1px); /* Horizontal lines */
        opacity: 0.5; /* Make grid subtle */
    }

    .map-location {
        position: absolute;
        width: 12px;
        height: 12px;
        margin-left: -6px; /* Center the dot horizontally */
        margin-top: -6px;  /* Center the dot vertically */
        border-radius: 50%; /* Make it a circle */
    }

    .map-location.warehouse {
        background-color: #007bff; /* Blue for warehouse */
        z-index: 10;
    }

    .map-location.destination {
        background-color: #dc3545; /* Red for destination */
        z-index: 10;
    }

    .map-location.truck {
        background-color: #ffc107; /* Yellow/Orange for truck */
        border: 1px solid #6c757d; /* Add border for visibility */
        z-index: 20; /* Ensure truck is above other points */
    }

    .map-label {
        position: absolute;
        white-space: nowrap; /* Prevent label text wrapping */
        background-color: rgba(255, 255, 255, 0.85); /* Semi-transparent white background */
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.75rem; /* Smaller font size for label */
        transform: translate(-50%, -150%); /* Position label above the dot */
        margin-top: -5px; /* Fine-tune vertical position */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Subtle shadow */
        z-index: 30; /* Ensure labels are on top */
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('amazon.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('amazon.order_list') }}">My Orders</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('amazon.order_detail', order_id=shipment.order_id) }}">Order #{{ shipment.order_id }}</a></li>
            <li class="breadcrumb-item active" aria-current="page">Shipment #{{ shipment.shipment_id }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="h4 mb-0">Shipment Tracking</h2>
                        <span class="badge bg-secondary">Tracking #{{ shipment.ups_tracking_id or shipment.shipment_id }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h5>Current Status:
                            {% if shipment.status == 'packing' %}
                                <span class="badge bg-info text-dark">Packing</span>
                            {% elif shipment.status == 'packed' %}
                                <span class="badge bg-info text-dark">Packed</span>
                            {% elif shipment.status == 'loading' %}
                                <span class="badge bg-warning text-dark">Loading</span>
                            {% elif shipment.status == 'loaded' %}
                                <span class="badge bg-primary">Loaded</span>
                            {% elif shipment.status == 'delivering' %}
                                <span class="badge bg-primary">Delivering</span>
                            {% elif shipment.status == 'delivered' %}
                                <span class="badge bg-success">Delivered</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ shipment.status|title }}</span>
                            {% endif %}
                        </h5>
                        <p class="text-muted"><small>Last Updated: {{ shipment.updated_at.strftime('%Y-%m-%d %H:%M:%S') }}</small></p>
                    </div>

                    <div class="mb-4">
                        <h5>Shipment Map</h5>
                        <div class="map-container">
                            <div class="map-grid"></div>

                            {% if shipment_data.warehouse %}
                            <div class="map-location warehouse"
                                 style="left: {{ shipment_data.warehouse.x | default(20) }}%; top: {{ shipment_data.warehouse.y | default(30) }}%;">
                            </div>
                            <div class="map-label"
                                 style="left: {{ shipment_data.warehouse.x | default(20) }}%; top: {{ shipment_data.warehouse.y | default(30) }}%;">
                                Warehouse #{{ shipment.warehouse_id }}
                            </div>
                            {% endif %}

                            {% if shipment.destination_x is not none and shipment.destination_y is not none %}
                            <div class="map-location destination"
                                 style="left: {{ shipment.destination_x }}%; top: {{ shipment.destination_y }}%;">
                            </div>
                            <div class="map-label"
                                 style="left: {{ shipment.destination_x }}%; top: {{ shipment.destination_y }}%;">
                                Destination ({{ shipment.destination_x }}, {{ shipment.destination_y }})
                            </div>
                            {% endif %}

                            {% if shipment.truck_id and shipment_data.truck_location and shipment.status in ['loaded', 'delivering'] %}
                            <div class="map-location truck"
                                 style="left: {{ shipment_data.truck_location.x }}%; top: {{ shipment_data.truck_location.y }}%;">
                            </div>
                            <div class="map-label"
                                 style="left: {{ shipment_data.truck_location.x }}%; top: {{ shipment_data.truck_location.y }}%;">
                                Truck #{{ shipment.truck_id }} ({{ shipment_data.truck_location.x }}, {{ shipment_data.truck_location.y }})
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-4">
                        <h5>Tracking Timeline</h5>
                        {% set statuses = ['packing', 'packed', 'loading', 'loaded', 'delivering', 'delivered'] %}
                        {% set current_status_index = statuses.index(shipment.status) if shipment.status in statuses else -1 %}

                        <div class="mt-4">
                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if current_status_index >= 0 %}active{% endif %}"></div>
                                    {% if current_status_index >= 0 %}<div class="tracking-line {% if current_status_index >= 1 %}active{% endif %}"></div>{% endif %}
                                </div>
                                <div class="ms-3 flex-grow-1">
                                    <h6>Order Received</h6>
                                    <p class="text-muted mb-0 small">Your order has been received and is being processed.</p>
                                    <small class="text-muted">{{ shipment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                </div>
                            </div>

                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if current_status_index >= 1 %}active{% endif %}"></div>
                                    {% if current_status_index >= 1 %}<div class="tracking-line {% if current_status_index >= 3 %}active{% endif %}"></div>{% endif %} {# Line connects to Loaded #}
                                </div>
                                <div class="ms-3 flex-grow-1">
                                    <h6>Package Packed</h6>
                                    <p class="text-muted mb-0 small">Your items have been packed and are ready for pickup.</p>
                                    {% if shipment_data.event_dates and shipment_data.event_dates.packed %}
                                    <small class="text-muted">{{ shipment_data.event_dates.packed.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% elif current_status_index >= 1 %}
                                    <small class="text-muted">Date unavailable</small>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if current_status_index >= 3 %}active{% endif %}"></div>
                                     {# Loading is often quick, connect Packed directly to Loaded line visually if Loaded is active #}
                                    {% if current_status_index >= 3 %}<div class="tracking-line {% if current_status_index >= 4 %}active{% endif %}"></div>{% endif %}
                                </div>
                                <div class="ms-3 flex-grow-1">
                                    <h6>Package Loaded on Truck</h6>
                                    <p class="text-muted mb-0 small">Your package has been loaded onto truck #{{ shipment.truck_id or 'TBD' }}.</p>
                                    {% if shipment_data.event_dates and shipment_data.event_dates.loaded %}
                                    <small class="text-muted">{{ shipment_data.event_dates.loaded.strftime('%Y-%m-%d %H:%M') }}</small>
                                     {% elif current_status_index >= 3 %}
                                    <small class="text-muted">Date unavailable</small>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if current_status_index >= 4 %}active{% endif %}"></div>
                                    {% if current_status_index >= 4 %}<div class="tracking-line {% if current_status_index >= 5 %}active{% endif %}"></div>{% endif %}
                                </div>
                                <div class="ms-3 flex-grow-1">
                                    <h6>Out for Delivery</h6>
                                    <p class="text-muted mb-0 small">Your package is out for delivery to ({{ shipment.destination_x }}, {{ shipment.destination_y }}).</p>
                                    {% if shipment_data.event_dates and shipment_data.event_dates.out_for_delivery %}
                                    <small class="text-muted">{{ shipment_data.event_dates.out_for_delivery.strftime('%Y-%m-%d %H:%M') }}</small>
                                     {% elif current_status_index >= 4 %}
                                    <small class="text-muted">Date unavailable</small>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if current_status_index >= 5 %}active{% endif %}"></div>
                                    {# No line needed after the last step #}
                                </div>
                                <div class="ms-3 flex-grow-1">
                                    <h6>Delivered</h6>
                                    <p class="text-muted mb-0 small">Your package has been delivered to the destination.</p>
                                    {% if shipment.status == 'delivered' and shipment_data.event_dates and shipment_data.event_dates.delivered %}
                                    <small class="text-muted">{{ shipment_data.event_dates.delivered.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% elif current_status_index >= 5 %}
                                    <small class="text-muted">Date unavailable</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <a href="{{ url_for('amazon.shipment_detail', shipment_id=shipment.shipment_id) }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-sync-alt me-1"></i> Refresh Status
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Shipment Details</h5>
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Shipment ID:</span>
                        <strong>#{{ shipment.shipment_id }}</strong>
                    </li>
                     {% if shipment.ups_tracking_id %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>UPS Tracking:</span>
                        <span>{{ shipment.ups_tracking_id }}</span>
                    </li>
                    {% endif %}
                    {% if shipment.ups_account %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>UPS Account:</span>
                        <span>{{ shipment.ups_account }}</span>
                    </li>
                    {% endif %}
                     <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span>Status:</span>
                        <span>
                             {% if shipment.status == 'packing' %}
                                <span class="badge bg-info text-dark">Packing</span>
                            {% elif shipment.status == 'packed' %}
                                <span class="badge bg-info text-dark">Packed</span>
                            {% elif shipment.status == 'loading' %}
                                <span class="badge bg-warning text-dark">Loading</span>
                            {% elif shipment.status == 'loaded' %}
                                <span class="badge bg-primary">Loaded</span>
                            {% elif shipment.status == 'delivering' %}
                                <span class="badge bg-primary">Delivering</span>
                            {% elif shipment.status == 'delivered' %}
                                <span class="badge bg-success">Delivered</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ shipment.status|title }}</span>
                            {% endif %}
                        </span>
                    </li>
                     <li class="list-group-item d-flex justify-content-between">
                        <span>Order ID:</span>
                        <a href="{{ url_for('amazon.order_detail', order_id=shipment.order_id) }}">#{{ shipment.order_id }}</a>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Warehouse:</span>
                        <span>#{{ shipment.warehouse_id }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Destination:</span>
                        <span>({{ shipment.destination_x }}, {{ shipment.destination_y }})</span>
                    </li>
                    {% if shipment.truck_id %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Truck ID:</span>
                        <span>#{{ shipment.truck_id }}</span>
                    </li>
                    {% endif %}
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Created:</span>
                        <span class="text-muted">{{ shipment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Last Updated:</span>
                        <span class="text-muted">{{ shipment.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </li>
                </ul>
            </div>

            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Shipment Items</h5>
                </div>
                {% if shipment_data.items %}
                <ul class="list-group list-group-flush">
                    {% for item in shipment_data.items %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 small">{{ item.product_name }}</h6>
                            <small class="text-muted d-block">ID: {{ item.product_id }}</small>
                        </div>
                        <span class="badge bg-secondary rounded-pill">x{{ item.quantity }}</span>
                    </li>
                    {% endfor %}
                </ul>
                {% else %}
                <div class="card-body">
                    <p class="text-muted">No items found in this shipment.</p>
                </div>
                {% endif %}
                <div class="card-footer text-center">
                    <a href="{{ url_for('amazon.order_detail', order_id=shipment.order_id) }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i> Back to Order Details
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}



{% block extra_js %}
<script>
    // Auto-refresh the page every minute to get the latest status
    setTimeout(function() {
        location.reload();
    }, 60000);
</script>
{% endblock %}{% endraw %}
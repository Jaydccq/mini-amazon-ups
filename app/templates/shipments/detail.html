{% extends "layout.html" %}

{% block title %}Shipment Tracking | Mini-Amazon{% endblock %}

{% block extra_css %}
<style>
    .tracking-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: #dee2e6;
        display: inline-block;
        margin-right: 8px;
    }
    
    .tracking-dot.active {
        background-color: #28a745;
    }
    
    .tracking-line {
        width: 2px;
        background-color: #dee2e6;
        height: 40px;
        margin-left: 9px;
        margin-bottom: -5px;
    }
    
    .tracking-line.active {
        background-color: #28a745;
    }
    
    .map-container {
        height: 300px;
        width: 100%;
        background-color: #f8f9fa;
        position: relative;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        overflow: hidden;
    }
    
    .map-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-size: 20px 20px;
        background-image: linear-gradient(to right, #e9ecef 1px, transparent 1px),
                         linear-gradient(to bottom, #e9ecef 1px, transparent 1px);
    }
    
    .map-location {
        position: absolute;
        width: 12px;
        height: 12px;
        margin-left: -6px;
        margin-top: -6px;
        border-radius: 50%;
    }
    
    .map-location.warehouse {
        background-color: #007bff;
    }
    
    .map-location.destination {
        background-color: #dc3545;
    }
    
    .map-location.truck {
        background-color: #28a745;
    }
    
    .map-label {
        position: absolute;
        white-space: nowrap;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 2px 5px;
        border-radius: 3px;
        font-size: 0.8rem;
        transform: translate(-50%, -100%);
        margin-top: -5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index.index') }}">Home</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('order.order_list') }}">My Orders</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('order.order_detail', order_id=shipment.order_id) }}">Order #{{ shipment.order_id }}</a></li>
            <li class="breadcrumb-item active">Shipment #{{ shipment.shipment_id }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="mb-0">Shipment Tracking</h2>
                        <span class="badge bg-primary">Tracking #{{ shipment.ups_tracking_id or shipment.shipment_id }}</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h5>Current Status: 
                            {% if shipment.status == 'packing' %}
                                <span class="badge bg-info">Packing</span>
                            {% elif shipment.status == 'packed' %}
                                <span class="badge bg-info">Packed</span>
                            {% elif shipment.status == 'loading' %}
                                <span class="badge bg-info">Loading</span>
                            {% elif shipment.status == 'loaded' %}
                                <span class="badge bg-primary">Loaded</span>
                            {% elif shipment.status == 'delivering' %}
                                <span class="badge bg-primary">Delivering</span>
                            {% elif shipment.status == 'delivered' %}
                                <span class="badge bg-success">Delivered</span>
                            {% endif %}
                        </h5>
                        <p>Last Updated: {{ shipment.updated_at.strftime('%Y-%m-%d %H:%M') }}</p>
                    </div>
                    
                    <!-- Shipment Map -->
                    <div class="mb-4">
                        <h5>Shipment Map</h5>
                        <div class="map-container">
                            <div class="map-grid"></div>
                            
                            <!-- Warehouse location -->
                            <div class="map-location warehouse"
                                 style="left: {{ (shipment_data.warehouse.x / 100)|default(0.2, true) * 100 }}%; 
                                        top: {{ (shipment_data.warehouse.y / 100)|default(0.3, true) * 100 }}%;">
                            </div>
                            <div class="map-label"
                                 style="left: {{ (shipment_data.warehouse.x / 100)|default(0.2, true) * 100 }}%; 
                                        top: {{ (shipment_data.warehouse.y / 100)|default(0.3, true) * 100 }}%;">
                                Warehouse #{{ shipment.warehouse_id }}
                            </div>
                            
                            <!-- Destination location -->
                            <div class="map-location destination"
                                 style="left: {{ (shipment.destination_x / 100) * 100 }}%; 
                                        top: {{ (shipment.destination_y / 100) * 100 }}%;">
                            </div>
                            <div class="map-label"
                                 style="left: {{ (shipment.destination_x / 100) * 100 }}%; 
                                        top: {{ (shipment.destination_y / 100) * 100 }}%;">
                                Destination ({{ shipment.destination_x }}, {{ shipment.destination_y }})
                            </div>
                            
                            <!-- Truck location (if available) -->
                            {% if shipment.truck_id and shipment_data.truck_location %}
                            <div class="map-location truck"
                                 style="left: {{ (shipment_data.truck_location.x / 100) * 100 }}%; 
                                        top: {{ (shipment_data.truck_location.y / 100) * 100 }}%;">
                            </div>
                            <div class="map-label"
                                 style="left: {{ (shipment_data.truck_location.x / 100) * 100 }}%; 
                                        top: {{ (shipment_data.truck_location.y / 100) * 100 }}%;">
                                Truck #{{ shipment.truck_id }}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Tracking Timeline -->
                    <div class="mb-4">
                        <h5>Tracking Timeline</h5>
                        
                        <div class="mt-4">
                            <!-- Step 1: Packing -->
                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if shipment.status != 'packing' %}active{% endif %}"></div>
                                    <div class="tracking-line {% if shipment.status != 'packing' %}active{% endif %}"></div>
                                </div>
                                <div class="ms-2">
                                    <h6>Order Received</h6>
                                    <p class="text-muted mb-0">Your order has been received and is being processed.</p>
                                    <small>{{ shipment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                                </div>
                            </div>
                            
                            <!-- Step 2: Packed -->
                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if shipment.status not in ['packing'] %}active{% endif %}"></div>
                                    <div class="tracking-line {% if shipment.status not in ['packing', 'packed'] %}active{% endif %}"></div>
                                </div>
                                <div class="ms-2">
                                    <h6>Package Packed</h6>
                                    <p class="text-muted mb-0">Your items have been packed and are ready for pickup.</p>
                                    {% if shipment_data.event_dates and shipment_data.event_dates.packed %}
                                    <small>{{ shipment_data.event_dates.packed.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Step 3: Loaded -->
                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if shipment.status not in ['packing', 'packed', 'loading'] %}active{% endif %}"></div>
                                    <div class="tracking-line {% if shipment.status not in ['packing', 'packed', 'loading', 'loaded'] %}active{% endif %}"></div>
                                </div>
                                <div class="ms-2">
                                    <h6>Package Loaded on Truck</h6>
                                    <p class="text-muted mb-0">Your package has been loaded onto truck #{{ shipment.truck_id or 'TBD' }}.</p>
                                    {% if shipment_data.event_dates and shipment_data.event_dates.loaded %}
                                    <small>{{ shipment_data.event_dates.loaded.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Step 4: Delivering -->
                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if shipment.status not in ['packing', 'packed', 'loading', 'loaded'] %}active{% endif %}"></div>
                                    <div class="tracking-line {% if shipment.status == 'delivered' %}active{% endif %}"></div>
                                </div>
                                <div class="ms-2">
                                    <h6>Out for Delivery</h6>
                                    <p class="text-muted mb-0">Your package is out for delivery to ({{ shipment.destination_x }}, {{ shipment.destination_y }}).</p>
                                    {% if shipment_data.event_dates and shipment_data.event_dates.out_for_delivery %}
                                    <small>{{ shipment_data.event_dates.out_for_delivery.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Step 5: Delivered -->
                            <div class="d-flex">
                                <div>
                                    <div class="tracking-dot {% if shipment.status == 'delivered' %}active{% endif %}"></div>
                                </div>
                                <div class="ms-2">
                                    <h6>Delivered</h6>
                                    <p class="text-muted mb-0">Your package has been delivered to the destination.</p>
                                    {% if shipment.status == 'delivered' and shipment_data.event_dates and shipment_data.event_dates.delivered %}
                                    <small>{{ shipment_data.event_dates.delivered.strftime('%Y-%m-%d %H:%M') }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Status Refresh Button -->
                    <div class="text-center mt-4">
                        <a href="{{ url_for('shipment.shipment_detail', shipment_id=shipment.shipment_id) }}" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Refresh Status
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Shipment Details</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Shipment ID:</span>
                        <span>#{{ shipment.shipment_id }}</span>
                    </div>
                    
                    {% if shipment.ups_tracking_id %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>UPS Tracking:</span>
                        <span>{{ shipment.ups_tracking_id }}</span>
                    </div>
                    {% endif %}
                    
                    {% if shipment.ups_account %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>UPS Account:</span>
                        <span>{{ shipment.ups_account }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Status:</span>
                        <span>
                            {% if shipment.status == 'packing' %}
                                <span class="badge bg-info">Packing</span>
                            {% elif shipment.status == 'packed' %}
                                <span class="badge bg-info">Packed</span>
                            {% elif shipment.status == 'loading' %}
                                <span class="badge bg-info">Loading</span>
                            {% elif shipment.status == 'loaded' %}
                                <span class="badge bg-primary">Loaded</span>
                            {% elif shipment.status == 'delivering' %}
                                <span class="badge bg-primary">Delivering</span>
                            {% elif shipment.status == 'delivered' %}
                                <span class="badge bg-success">Delivered</span>
                            {% endif %}
                        </span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Order ID:</span>
                        <span><a href="{{ url_for('order.order_detail', order_id=shipment.order_id) }}">#{{ shipment.order_id }}</a></span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Warehouse:</span>
                        <span>#{{ shipment.warehouse_id }}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Destination:</span>
                        <span>({{ shipment.destination_x }}, {{ shipment.destination_y }})</span>
                    </div>
                    
                    {% if shipment.truck_id %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>Truck ID:</span>
                        <span>#{{ shipment.truck_id }}</span>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Created:</span>
                        <span>{{ shipment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <span>Last Updated:</span>
                        <span>{{ shipment.updated_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Shipment Items -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Shipment Items</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for item in shipment_data.items %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">{{ item.product_name }}</h6>
                                <small class="text-muted">ID: {{ item.product_id }}</small>
                            </div>
                            <span class="badge bg-secondary rounded-pill">x{{ item.quantity }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <a href="{{ url_for('order.order_detail', order_id=shipment.order_id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Back to Order
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Auto-refresh the page every minute to get the latest status
    setTimeout(function() {
        location.reload();
    }, 60000);
</script>
{% endblock %}